# 笔记

## 1. 概述
框架图：
![Kiku](img/fig-1.1.jpg)

    客户端：客户端一般是用户用于收发消息的终端设备
    接入服务：连接保持、协议解析、Session 维护和消息推送
    业务处理服务：业务处理服务是真正的消息业务逻辑处理层，比如消息的存储、未读数变更、更新最近联系人等
    存储服务：账号信息、关系链，以及消息
    外部接口服务： 

为什么接入服务和业务处理服务要独立拆分？ 

    1. 接入服务作为消息收发的出入口，必须是一个高可用的服务，保持足够的稳定性是一个必要条件
    2. 从业务开发人员的角度看，接入服务和业务处理服务进行拆分有助于提升业务开发效率，降低业务开发门槛

IM系统特性：

    1. 实时性，保证消息实时触达是互动场景的必备能力。
    2. 可靠性，“不丢消息”和“消息不重复”是系统值得信赖的前置条件。
    3. 一致性，“多用户”“多终端”的一致性体验能大幅提升 IM 系统的使用体验。
    4. 安全性，“数据传输安全”“数据存储安全”“消息内容安全“三大保障方面提供全面隐私保护。

## 2. 消息收发
### 1. 消息存储
简单表单设计

a） 内容表单：![GitHub Logo](/img/fig-2.1.png)
    索引表单：![GitHub Logo](/img/fig-2.2.png)

b）最近联系人（这个不是很认同），暂且不表（根据需求来确定）
![GitHub Logo](/img/fig-2.3.png)

### 2. 消息收发通道
两种方案
1） IM 服务端提供一个 HTTP 协议的 API 接口，客户端需要发送消息时，调用这个接口把消息发给 IM 服务端。
2） 客户端和 IM 服务端维护一个 TCP 长连接，客户端有消息发送时，会以私有协议来封装这条要发送的消息，然后通过这个 TCP 长连接把消息发给 IM 服务端。

现有业务逻辑
框架图：![GitHub Logo](/img/fig-2.4.png)
IM 服务端的网关服务和消息接收方设备之间维护一条 TCP 长连接（或者 Websocket 长连接），借助 TCP 的全双工能力，也就是能够同时接收与发送数据的能力。当有消息需要投递时，通过这条长连接实时把消息从 IM 服务端推送给接收方。对于接收方不在线（比如网络不通、App 没打开等）的情况，还可以通过第三方手机操作系统级别的辅助通道，把这条消息通过手机通知栏的方式投递下去。这里简单解释一下，常见的第三方操作系统级别的辅助通道。比如苹果手机的 APNs（Apple Push Notification Service）通道、Android 手机的 GCM 通道，还有各种具体手机厂商（如小米、华为等）提供的厂商通道。

## 3. 轮询与长连接：如何解决消息的实时到达问题
1. 短轮询
2. 长轮询
3. websocket
4. 基于TCP长连接衍生的IM协议

### 4. ACK机制：如何保证消息的可靠投递
